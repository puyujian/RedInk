# 管理员账户创建指南

本文档介绍如何为 RedInk 系统创建初始管理员账户。

## 问题背景

RedInk 后台管理系统需要管理员权限才能访问。但出于安全考虑:
- 普通用户注册时只能创建 `user` 或 `pro` 角色账户
- 只有管理员才能创建其他管理员账户
- 因此需要先创建第一个管理员账户

## 解决方案

系统提供了两种创建初始管理员的方式:

### ⚠️ 重要安全说明

为确保系统安全,管理员密码必须满足以下要求:
- ✅ 长度至少 **8 个字符**(建议 12 位以上)
- ✅ 至少包含以下 **2 种** 字符类型:
  - 小写字母 (a-z)
  - 大写字母 (A-Z)
  - 数字 (0-9)
  - 特殊符号 (!@#$%^&*等)
- ✅ 建议包含 **3 种或以上** 字符类型以提高安全性

**示例:**
- ❌ `admin123` - 太简单,只有小写+数字
- ❌ `password` - 太弱,只有小写字母
- ✅ `Admin@2024` - 符合要求(大写+小写+数字+符号)
- ✅ `MySecurePass2024!` - 强密码推荐

---

### 方案1: 环境变量自动创建 (推荐)

**适用场景:** 生产环境、容器化部署、自动化运维

**步骤:**

1. 在 `.env` 文件或环境变量中配置管理员凭证:

```bash
# 启用自动创建功能(默认为 true)
ADMIN_BOOTSTRAP_ON_START=true

# 管理员凭证
INITIAL_ADMIN_USERNAME=admin
INITIAL_ADMIN_PASSWORD=your_secure_password_here
INITIAL_ADMIN_EMAIL=admin@your-domain.com
```

2. 运行数据库初始化:

```bash
python backend/init_db.py
```

3. 系统会自动检测:
   - ✅ 如果数据库中没有管理员账户,且配置完整,自动创建
   - ⏭️ 如果已存在管理员,跳过创建(幂等性保证)
   - ⚠️ 如果缺少密码配置,给出警告并跳过

4. 创建成功后,日志会显示:

```
=================================================================
✅ 初始管理员账户创建成功!
   用户ID: 1
   用户名: admin
   邮箱: admin@your-domain.com
=================================================================
```

**安全建议:**
- ✅ 首次登录后立即修改密码
- ✅ 修改密码后,从环境变量中删除 `INITIAL_ADMIN_PASSWORD`
- ✅ 使用强密码(至少12位,包含大小写字母、数字、符号)
- ✅ 在容器编排环境中,使用 Secret 管理密码,不要硬编码
- ✅ **生产环境建议修改默认用户名**:将 `INITIAL_ADMIN_USERNAME` 设置为项目专用名称(如 `redink_admin`),避免使用常见的 `admin`

**生产环境注意事项:**
- ⚠️ 确保在应用启动前已完成数据库表结构迁移/初始化
- ⚠️ 系统会在应用启动时尝试创建管理员,但需要数据库表已存在
- ⚠️ 建议在部署流程中先运行 `python backend/init_db.py` 完成初始化

---

### 方案2: CLI 命令行工具

**适用场景:** 开发环境、服务器手动操作、补救措施

**步骤:**

1. 进入项目目录并运行创建工具:

```bash
python backend/create_admin.py
```

2. 按照交互式提示输入信息:

```
======================================================================
RedInk 管理员账户创建工具
======================================================================

请输入管理员账户信息:
----------------------------------------------------------------------
用户名: admin
邮箱: admin@example.com
密码(输入隐藏): ******
确认密码: ******

----------------------------------------------------------------------
即将创建管理员账户:
  用户名: admin
  邮箱: admin@example.com
  角色: admin
----------------------------------------------------------------------
确认创建? (yes/no): yes

======================================================================
✅ 管理员账户创建成功!
   用户ID: 1
   用户名: admin
   邮箱: admin@example.com
======================================================================

现在您可以使用此账户登录后台管理系统了
```

**工具特性:**
- ✅ 密码输入隐藏
- ✅ 二次确认密码
- ✅ 检查用户名/邮箱冲突
- ✅ 格式验证(用户名3-50字符,**密码至少8字符且符合复杂度要求**)
- ✅ 密码强度检查(至少包含2种字符类型)
- ✅ 幂等性保证(不会重复创建)

---

## 登录后台

创建管理员账户后,可以通过以下方式登录:

### 1. API 登录

```bash
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "your_password"
  }'
```

响应示例:
```json
{
  "success": true,
  "user": {
    "id": 1,
    "uuid": "...",
    "username": "admin",
    "email": "admin@example.com",
    "role": "admin"
  },
  "access_token": "eyJ...",
  "refresh_token": "eyJ..."
}
```

### 2. 前端登录

访问前端登录页面(例如 `http://localhost:5173/login`),使用管理员用户名和密码登录。

### 3. 访问后台管理

登录成功后,可以访问管理后台:
- 用户管理: `GET /api/admin/users`
- 生成记录管理: `GET /api/admin/records`
- 图片管理: `GET /api/admin/images`
- 配置管理: `GET /api/admin/config/image-providers`
- 注册配置: `GET /api/admin/registration`
- 审计日志: `GET /api/admin/audit-logs`

---

## 故障排查

### 问题1: 环境变量创建失败

**症状:** 运行 `init_db.py` 后没有创建管理员,日志显示警告

**可能原因:**
- 未设置 `INITIAL_ADMIN_PASSWORD` 环境变量
- 用户名或邮箱已被占用
- `ADMIN_BOOTSTRAP_ON_START` 被设置为 `false`

**解决方案:**
1. 检查 `.env` 文件是否正确配置
2. 确认环境变量已加载:`python -c "from backend.config import Config; print(Config.INITIAL_ADMIN_PASSWORD)"`
3. 如果配置正确但仍失败,使用 CLI 工具手动创建

### 问题2: CLI 工具报错"用户名已存在"

**原因:** 数据库中已存在同名用户,但角色不是 admin

**解决方案:**
1. 使用不同的用户名重新创建
2. 或者删除现有用户后重新创建
3. 或者直接将现有用户角色改为 admin(需要数据库操作)

### 问题3: 无法访问 `/api/admin/*` 端点

**可能原因:**
- 未登录或 token 过期
- 使用的账户不是 admin 角色
- Authorization 头格式错误

**解决方案:**
1. 确认已登录并获取有效的 `access_token`
2. 在请求头中正确设置:`Authorization: Bearer <access_token>`
3. 确认用户角色为 `admin`

---

## 安全最佳实践

1. **首次登录后立即修改密码**
   - 登录后访问 `/api/admin/users/{user_id}` 修改密码

2. **使用强密码**
   - 至少12位字符
   - 包含大小写字母、数字、特殊符号
   - 不使用常见密码或个人信息

3. **保护环境变量**
   - 不要将 `.env` 文件提交到版本控制
   - 生产环境使用密钥管理服务(如 AWS Secrets Manager)
   - 容器环境使用 Kubernetes Secrets

4. **定期更新密码**
   - 建议每3-6个月更换一次管理员密码

5. **最小权限原则**
   - 日常操作使用普通用户账户
   - 仅在需要时使用管理员账户

6. **审计日志**
   - 定期检查 `/api/admin/audit-logs` 查看管理操作记录
   - 发现异常立即调查

---

## 常见问题 FAQ

**Q: 可以创建多个管理员吗?**
A: 可以。首个管理员创建后,可以通过后台管理界面 `/api/admin/users` 创建更多管理员。

**Q: 忘记管理员密码怎么办?**
A: 使用 CLI 工具重新创建管理员账户(使用不同的用户名),或直接在数据库中重置密码哈希。

**Q: 环境变量会暴露密码吗?**
A: 密码仅在首次创建时使用,创建后立即删除环境变量中的密码配置即可。

**Q: Docker 环境如何配置?**
A: 在 `docker-compose.yml` 中使用 `environment` 或 `env_file` 配置,或使用 Docker Secrets。

**Q: 自动创建会重复吗?**
A: 不会。系统会检查是否已存在管理员,已存在时跳过创建(幂等性保证)。

---

## 相关文档

- [用户认证 API 文档](./api_auth.md)
- [管理后台 API 文档](./api_admin.md)
- [环境变量配置](./environment.md)
- [安全配置指南](./security.md)
